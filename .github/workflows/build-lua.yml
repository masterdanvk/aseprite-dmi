name: Build Lua
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-lua.yml'

jobs:
  build-lua:
    name: Build Lua in Steam Runtime
    runs-on: ubuntu-latest
    steps:
      - name: Build in Steam Runtime container
        uses: addnab/docker-run-action@v3
        with:
          image: registry.gitlab.steamos.cloud/steamrt/scout/sdk
          options: -v ${{ github.workspace }}:/work
          run: |
            # start
            set -ex
            apt-get update
            apt-get install -y curl build-essential

            WORKDIR="/tmp/lua-build"
            mkdir -p "$WORKDIR"
            cd "$WORKDIR"

            # Download with proper error checking
            curl -fsSL "https://www.lua.org/ftp/lua-5.4.7.tar.gz" --output lua.tar.gz

            # Verify download
            if [ ! -s lua.tar.gz ]; then
              echo "Download failed or file is empty"
              exit 1
            fi

            # Extract with verification
            tar xf lua.tar.gz
            if [ ! -d "lua-5.4.6" ]; then
              echo "Extraction failed"
              exit 1
            fi

            cd "lua-5.4.6"

            # Create patches
            cat > lua-shared-lib.patch << 'EOF'
            --- a/src/Makefile
            +++ b/src/Makefile
            @@ -31,7 +31,7 @@
             PLATS= aix bsd c89 freebsd generic linux macosx mingw posix solaris

             # What to install.
            -TO_BIN= lua luac
            +TO_BIN= lua luac liblua.so

             # Lua version and release.
             V= 5.4
            @@ -51,7 +51,7 @@
             # -DLUA_COMPAT_5_2 controls other macros for compatibility with Lua 5.2.
             MYCFLAGS=
             MYLDFLAGS=
            -MYLIBS= -lm
            +MYLIBS= -lm -ldl

             # == END OF USER SETTINGS. NO NEED TO CHANGE ANYTHING BELOW THIS LINE =========

            @@ -64,7 +64,7 @@
             # Targets start here.
             all:    $(PLAT)

            -$(PLATS) clean:
            +$(PLATS) clean: liblua.so

             $(PLATS):
                $(MAKE) -C src $@

            @@ -78,6 +78,9 @@
                $(MAKE) -C src $@

             linux:
            +   $(CC) -shared -o liblua.so $(MYCFLAGS) $(MYLDFLAGS) $(LUA_A) $(MYLIBS)
            +   cp liblua.so ../
            +
                $(MAKE) $(ALL) SYSCFLAGS="-DLUA_USE_LINUX" SYSLIBS="-Wl,-E -ldl"

             macosx:
            EOF

            patch -p1 < lua-shared-lib.patch

            cd src

            # Clean build first
            make clean

            # Build all object files
            gcc -std=gnu99 -O2 -Wall -Wextra -DLUA_COMPAT_5_3 -DLUA_USE_LINUX $(SYSCFLAGS) $(MYCFLAGS) -fPIC -c *.c

            # Build shared library directly
            gcc -shared -o liblua5.4.so *.o -lm -ldl -o liblua5.4.so

            # Test the library
            nm -D liblua5.4.so | grep ' T ' || echo "No exported symbols found!"
            ldd liblua5.4.so || echo "Library dependencies not found!"

            mkdir -p /work/artifacts
            cp liblua5.4.so /work/artifacts/

            # Verify copy
            if [ ! -f /work/artifacts/liblua5.4.so ]; then
              echo "Failed to copy library"
              exit 1
            fi

      - name: Upload Lua library
        uses: actions/upload-artifact@v4
        with:
          name: steamrt-lua
          path: artifacts/liblua5.4.so
          if-no-files-found: error
